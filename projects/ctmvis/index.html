
<!DOCTYPE html>
<meta charset="utf-8">
<title>CTM Vis</title>
<body>
<div id="tooltip">
Topic Information
</div>
<div id="tools">
<link rel="stylesheet" type="text/css" href="style.css" />
<div id="info">
    <ul>
        <li>Info
            <ul>
                <li style="background: rgba(0, 0, 0, .2); border: 1px dotted rgba(0, 0, 0, .6)">
                    <strong>What's this:</strong>
                    <ol style="color: #d9d9d9;">
                        <li>• A visualization prototype for <a href="http://www.ml-thu.net/~scalable-ctm/">Scalable Correlated Topic Model</a>.</li>
                        <li>• A tool to browse 1000 topics from New York Times.</li>
                    </ol>
                </li>
                <li style="background: rgba(0, 0, 0, .2); border: 1px dotted rgba(0, 0, 0, .6)">
                    <strong>How to use it:</strong>
                    <ol style="color: #d9d9d9;">
                        <li>• Search key word for topic.</li>
                        <li>• Adjust correlation threshold for visible link.</li>
                        <li>• Uses mouse wheel for zooming.</li>
                        <li>• Move mouse cursor to show information about focused topic cluster.</li>
						<li>• Click topic cluster node to view topics inside.</li>
						<li>• Click background to return.</li>
						<li>• Click Clear Button to clear transformed node and links.</li>
                    </ol>
                </li>
                <li>
                    <small>© 2013 Created by <a href="http://zi-wang.com/">Zi Wang</a>.<br/>
                    New York Times data generated by <a href="http://www.ml-thu.net/~scalable-ctm/">State Key Lab of Intelligent Technology and Systems</a>. Powered by <a href="http://d3js.org" title="D3js">D3.js</a>.</small>
                </li>
            </ul>
        </li>
		<li><a href="http://www.ml-thu.net/~scalable-ctm/" style="display: block; overflow: hidden;  padding-top: 5px;">gCTM</a></li>
    </ul>
</div>

<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

<ul>
	<li class="ui-widget">
		<label>Options </label>
        <div>
            <input id="chtopic" type="checkbox" checked="checked">
            <label for="chtopic">Show topic information</label>
        </div>
    </li>
	<li class="ui-widget" id="sliderContainer">
			<label for="slider">Correlation threshold: <span id="similarity"></span></label>
			<div id="slider"></div>
	</li>
	<li class="ui-widget" id="searchContainer">
	  <label for="search">Search </label>
	  <input type="text" id="search" name="searchword" value="" />
	</li>
	<li><a class="btn" id="clearbtn">Clear</a></li>
</ul>
</div>
<script src="pace.min.js"></script>
<link href="flash-white.css" rel="stylesheet" />
<script src="d3/d3.v3.min.js"></script>
<script>
	$('#chtopic').click( function(d) {
		temp = this.checked;
		d3.select("#tooltip").style("display", function () {return temp ? "block":"none";})
    });

	$('#search').bind("change keyup", function() {
    searchWord = $(this).val();
	//console.log(searchWord);
    if (searchWord.length >= 3) {
		d3.selectAll("circle").attr("r", function(d) { return d.title.match(RegExp(searchWord, 'i')) ? 5*Math.sqrt(d.size*10):( d.fixed == true ? 3*Math.sqrt(d.size*10): Math.sqrt(d.size*10)); });
		d3.selectAll("text")
		  .style("font-size", function (d) {return d.title.match(RegExp(searchWord, 'i')) || d.fixed == true ? 50: 15})
		  .style("stroke-width", function (d) {return d.title.match(RegExp(searchWord, 'i')) || d.fixed == true ? 1.5: 0})
		  .style("stroke", "#fdff00")
		  .attr("transform",function(d) { transoff = d.title.match(RegExp(searchWord, 'i')) || d.fixed == true? 5*Math.sqrt(d.size*10) :　Math.sqrt(d.size*10); return "translate("+transoff+","+transoff+")"; });
		//d3.selectAll(".link").style("stroke", function(d) { console.log(d);return d.source.label.match(RegExp(searchWord, 'i')) || d.target.label.match(RegExp(searchWord, 'i'))? "#fdff00" : "#999"})
		  //.style("stroke-width", function(d) { return d.source.label.match(RegExp(searchWord, 'i')) || d.target.label.match(RegExp(searchWord, 'i'))? Math.sqrt(d.value*100)*3 : Math.sqrt(d.value*100);});
					
	}
	});
	$('#clearbtn').click(function () {
		d3.select("#tooltip").select("div").remove();
		d3.selectAll("circle").attr("r", function(d) {
			d.firstclick = true;
			d.fixed = false;
			return Math.sqrt(d.size*10); })
		  d3.selectAll("text")
		  .style("font-size", function (d) {return 15})
		  .style("stroke-width", function (d) {return 0})
		  .style("stroke", "#999")
		  .attr("transform",function(d) { transoff = Math.sqrt(d.size*10); return "translate("+transoff+","+transoff+")"; });
		d3.selectAll(".link").style("stroke", function(d) { return "#999"})
		  .style("stroke-width", function(d) { return Math.sqrt(d.value*100);});
		drawparent();
	});
	var width = $(window).width(), height = $(window).height();
	var corThreshold = 25;
	var inlevel2 = 1;
	var changelevel = false;
	var curobj, curi, curgraph;
	var lastthres;
	function filterChange(event, ui) {
		corThreshold = ui.value;
		if (!changelevel) {
		if (inlevel2 == 1) {
			d3.selectAll(".node").remove();
			d3.selectAll(".link").remove();
			restart();
		} else {
			d3.select("#rectc").remove();
			d3.selectAll(".childnode").remove();
			d3.selectAll(".childlink").remove();
			drawchildren(curobj,curi);
		}
		}
	}
	var color = d3.scale.category20();
	var zoom = d3.behavior.zoom().center([width / 2, height / 2]).size(width,height).scaleExtent([0.2, 10]).on("zoom", redraw);
	var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height).append("g");
		svg.call(zoom)
		.append("g");
	function redraw() {
		svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
	}
	var rect = svg.append("rect")
		.attr("width", width)
		.attr("height", height)
		.attr("opacity",0);

	restart();
	$( "#slider" ).slider({ change: filterChange, value: corThreshold, min: 0, max: 40});
	function drawchildren(d,i) {
		changelevel = true;
		$( "#slider" ).slider({ min: 10, max: 80});
		var childthres = corThreshold*10;
		$('#similarity').html(Math.round(childthres)*0.1+"%");
		inlevel2 = 0;
		curobj = d;
		curi = i;
		var rectc = svg.append("rect")
		.attr("id","rectc")
		.attr("width", "100%")
		.attr("height", "100%")
		.attr("opacity",0);
		rectc.on("click",drawparent);
		d3.selectAll(".node").transition()
		  .duration(500).attr("opacity",0.1);//remove();
		d3.selectAll(".node").on("click",function (d){});
		d3.selectAll(".link").transition()
		  .duration(500).attr("opacity",0.1);//.remove();
		//console.log(d);
		var parentgroup = d.group;
		var childgraph= d.children;
		//console.log(childgraph);
		var cforce = d3.layout.force()
		.charge(-8000)
		.linkDistance(1000/Math.sqrt(childgraph.nodes.length))
		.size([width, height])
		.theta(0.2)
		.gravity(0.8);
		cforce
		  .nodes(childgraph.nodes)
		  .links(childgraph.links.filter(function (link){
				return link.value > childthres/1000;
		  }))
		  .linkStrength(function(d) { return Math.sqrt(2/d.value); })
		  .start();
		var clink = svg.selectAll(".childlink")
		  .data(cforce.links())
		  .enter().append("line")
		  .attr("class", "childlink")
		  .style("stroke-width", function(d) { return Math.sqrt(d.value*100); });
		var cnode = svg.selectAll(".childnode")
		  .data(cforce.nodes())
		  .enter().append("svg:g")
		  .attr("class","childnode");
		var ccir=cnode.append("circle").transition()
		  .duration(500)
		  .attr("r", 10)
		  .style("fill", function(d) {d.size = 10; return color(parentgroup); })
		//cnode.append("title")
		//  .text(function(d) { return d.title.replace('_',' '); });
		cnode.append("svg:text")
		  .text(function(d) { 
		  return d.label.replace('_',' '); }).transition()
		  .duration(500)
		  .style("fill", function(d) { return color(parentgroup); })
		  .style("font-family", "Verdana,Arial")
		  .style("font-size", 10)
		  .style("stroke-width", 0)
		  .attr("transform","translate(-15,-15)");

		cnode.on("mouseover",function(nn){
			d3.select("#tooltip").select("div").remove();
			d3.select("#tooltip").append("div").html(nn.title.replace(/\n/g,'</br>').replace(/\s/g,'\t'));
			d3.select(this).select("circle")
			.attr("r", 50);
			d3.select(this).select("text")
			.style("font-size", 50)
			.style("stroke", "#fdff00")
			.style("stroke-width", 1.5)
			.attr("transform","translate(-50,-50)");
			clink.style("stroke", function(d) { return d.source.id == nn.id || d.target.id == nn.id? "#fdff00" : "#999"})
			.style("stroke-width", function(d) { return d.source.id == nn.id || d.target.id == nn.id? Math.sqrt(d.value*100)*2 : Math.sqrt(d.value*100);});
			cforce.gravity(function (d) {return d.id == nn.id ? 0.75 :0.8})
			.start();
		  })
		  .on("mouseout",function(){
			d3.select(this).select("circle").attr("r", 10);
		
			d3.select(this).select("text").style("font-size", 10)
			  .style("stroke-width", 0)
			  .attr("transform","translate(-15,-15)");
			clink.style("stroke", function (d) { return d.source.fixed == true || d.target.fixed == true ? "#fdff00":"#fff"})
			.style("stroke-width", function(d) { return Math.sqrt(d.value*100); });
			cforce.gravity(0.8)
		  });
	  cnode.call(cforce.drag);

	  cforce.on("tick", function() {
		clink.attr("x1", function(d) { return d.source.x; })
			.attr("y1", function(d) { return d.source.y; })
			.attr("x2", function(d) { return d.target.x; })
			.attr("y2", function(d) { return d.target.y; });
	  rectc.on("click",drawparent);
	  cnode.attr("transform",function(d){return "translate("+d.x+","+d.y+")"})
	  });
	  changelevel = false;
	}
	function drawparent(d,i) {
		inlevel2 = 1;
		changelevel = true;
		corThreshold = lastthres;
		$( "#slider" ).slider({ change: filterChange, value: corThreshold, min: 0, max: 40});
		$('#similarity').html(Math.round(corThreshold)*0.1+"%");
		d3.select("#rectc").remove();
		d3.selectAll(".childnode").transition()
		  .duration(500).remove();
		d3.selectAll(".childlink").transition()
		  .duration(500).remove();
		d3.selectAll(".node").transition()
		  .duration(500).attr("opacity",0.9);//remove();
		d3.selectAll(".link").transition()
		  .duration(500).attr("opacity",0.6);//.remove();
		changelevel = false;
		//d3.selectAll(".node").on("click", drawchildren);
		d3.selectAll(".node").on("click",function(nn){
			if (nn.firstclick) {
				zoom.center([nn.x, nn.y]);
				//zoom.scale(zs);
				//force.start();
				nn.firstclick = false;
				//console.log(nn);
				nn.fixed = true;
				d3.select(this).select("circle")			
					.attr("r", function(d) { return 3*Math.sqrt(d.size*10); });
				d3.select(this).select("text")
				  .style("font-size", 50)
				  .style("stroke-width", 1.5)
				  .style("stroke", "#fdff00")
				  .attr("transform",function(d) { transoff = 3*Math.sqrt(d.size*10); return "translate("+transoff+","+transoff+")"; });
				d3.selectAll(".link").style("stroke", function(d) { return d.source.id == nn.id || d.target.id == nn.id? "#fdff00" : "#999"})
				  .style("stroke-width", function(d) { return d.source.id == nn.id || d.target.id == nn.id? Math.sqrt(d.value*100)*3 : Math.sqrt(d.value*100);});
				drawchildren(nn)
				//$('#childviewbtn').click(drawchildren(nn));
				//force.gravity(function (d) {return d.id == nn.id ? 0.78 :0.8})
				
			}
			else {
				nn.fixed = false;
				d3.select(this).select("circle")
				  .attr("r", function(d) { return Math.sqrt(d.size*10); });
			
				d3.select(this).select("text")
				  .style("font-size", 15)
				  .transition()
				  .duration(2000)
				  .style("stroke-width", 0)
				  .attr("transform",function(d) { transoff = Math.sqrt(d.size*10); return "translate("+transoff+","+transoff+")"; });
				  
				d3.selectAll(".link").style("stroke", "#999")
				  .style("stroke-width", function(d) { return Math.sqrt(d.value*100)});
				//force.gravity(0.8);
				nn.firstclick = true;
			}
		})
		  //restart();
	}
	function restart() {
		$('#similarity').html(Math.round(corThreshold)*0.1+"%");
		lastthres = corThreshold;
		var force = d3.layout.force()
		  .charge(-4000)
		  .linkDistance(6000/corThreshold)
		  .size([width, height])
		  .theta(0.5)
		  .gravity(0.8);
		d3.json("l2.min.json", function(error, graph) {
		force
		  .nodes(graph.nodes)
		  .links(graph.links.filter(function (link) {
			return link.value > corThreshold/1000;
		  }))
		  .linkStrength(function(d) { return Math.sqrt(0.2/d.value); })
		  .start();

		var link = svg.selectAll(".link")
		  .data(graph.links)
		  .enter().append("line")
		  .attr("class", "link")
		  .attr("opacity",0.6)
		  .style("stroke-width", function(d) { return Math.sqrt(d.value*100); });

		var node = svg.selectAll(".node")
		  .data(force.nodes())
		  .enter().append("svg:g")
		  .attr("class", "node")
		  .attr("opacity",0.9);

		var cir=node.append("circle")
		  .attr("r", function(d) {
			d.firstclick = true;
			return Math.sqrt(d.size*10); })
		  .style("fill", function(d) { return color(d.group); })
			//  .attr("class","node");
			
		//node.append("title")
		//  .text(function(d) { return d.title.replace('_',' '); });
		  
		node.append("text")
		  .text(function(d) { 
			return d.label.replace('_',' '); })
		  .style("fill", function(d) { return color(d.group); })
		  .style("font-family", "Verdana,Arial")
		  .style("font-size", 15)
		  .style("stroke-width", 0)
		  .style("text-shadow", "0 0 20px rgba(255, 255, 255, .9)")
		  .attr("transform",function(d) {
			var offset = Math.sqrt(d.size*10)+2;
			return "translate("+offset+","+offset+")"})
		node.on("mouseover", function (nn) {
		  //console.log(nn.title);
		  d3.select("#tooltip").select("div").remove();
		  d3.select("#tooltip").append("div").html(nn.title.replace(/\n/g,'</br>').replace(/\s/g,'\t'));
		  link.style("stroke", function(d) { 
			  return d.source.id == nn.id || d.target.id == nn.id || d.source.fixed == true || d.target.fixed == true ? "#fdff00" : "#999"})
			.style("stroke-width", function(d) { return d.source.id == nn.id || d.target.id == nn.id? Math.sqrt(d.value*100)*3 : Math.sqrt(d.value*100);});
		});
		node.on("click",function(nn){
			if (nn.firstclick) {
				zoom.center([nn.x, nn.y]);
				//zoom.scale(zs);
				//force.start();
				nn.firstclick = false;
				//console.log(nn);
				nn.fixed = true;
				d3.select(this).select("circle")			
					.attr("r", function(d) { return 3*Math.sqrt(d.size*10); });
				d3.select(this).select("text")
				  .style("font-size", 50)
				  .style("stroke-width", 1.5)
				  .style("stroke", "#fdff00")
				  .attr("transform",function(d) { transoff = 3*Math.sqrt(d.size*10); return "translate("+transoff+","+transoff+")"; });
				link.style("stroke", function(d) { return d.source.id == nn.id || d.target.id == nn.id? "#fdff00" : "#999"})
				  .style("stroke-width", function(d) { return d.source.id == nn.id || d.target.id == nn.id? Math.sqrt(d.value*100)*3 : Math.sqrt(d.value*100);});
				drawchildren(nn)
				//$('#childviewbtn').click(drawchildren(nn));
				//force.gravity(function (d) {return d.id == nn.id ? 0.78 :0.8})
				
			}
			else {
				nn.fixed = false;
				d3.select(this).select("circle")
				  .attr("r", function(d) { return Math.sqrt(d.size*10); });
			
				d3.select(this).select("text")
				  .style("font-size", 15)
				  .transition()
				  .duration(2000)
				  .style("stroke-width", 0)
				  .attr("transform",function(d) { transoff = Math.sqrt(d.size*10); return "translate("+transoff+","+transoff+")"; });
				  
				link.style("stroke", "#999")
				  .style("stroke-width", function(d) { return Math.sqrt(d.value*100)});
				force.gravity(0.8);
				nn.firstclick = true;
			}
		})
			/*
			  .on("mouseout",function(nn){
			  nn.fixed = false;
			  d3.select(this).select("circle")
			  .attr("r", function(d) { return Math.sqrt(d.size*10); });
			
			  d3.select(this).select("text")
			  .style("font-size", 15)
			  .transition()
			  .duration(2000)
			  .style("stroke", "#fff")
			  .attr("transform","translate(-15,-15)");
			  
			  link.style("stroke", "#999")
			  .style("stroke-width", function(d) { return Math.sqrt(d.value*100)});
			  force.gravity(0.8);
			  });
			*/  
		//node.on("ondbclick", drawchildren);
		node.call(force.drag);

		force.on("tick", function() {
			link.attr("x1", function(d) { return d.source.x; })
				.attr("y1", function(d) { return d.source.y; })
				.attr("x2", function(d) { return d.target.x; })
				.attr("y2", function(d) { return d.target.y; });

			node.attr("transform",function(d){return "translate("+d.x+","+d.y+")"})
		  });
		});
	}
	
  </script>
  <script>
	$(function() {
		var availableTags = ["GEORGE BUSH","resident","slavery","con","DELTA","SMITH","victim","car","VETERAN","percent","JAYSON WILLIAM","EAST TEXAS","military","music","SOUTHERN","radio","goodwill","team","MEMORIAL DAY","search","XFL","school","film","hour","LONDON","UNILEVER","word","telegram","protest","MARK TWAIN","male","team","brain","laden","SOTHEBY","mail","attack","percent","corp","DVD","sleep","dancer","black","team","DARRYL STRAWBERRY","license","privacy","FLORIDA","patient","INDIA","newspaper","jewish","official","PHOENIX","truck","room","fund","law","send","gun","BAILEY","plague","CENTRAL TEXAS","motto","newspaper","SOUTH AFRICA","police","VERIZON","boss","guy","ticket","MUSLIM","company","realize","bean","today","advertising","bond","opium","web","horse","czech","EARL WOOD","book","LOS ANGELES","KANSAS CITY","bone","games","company","NORTHERN CALIFORNIA","strike","SECURITY","platform","water","BOB KNIGHT","roller","italian","european","AUSTRALIA","hearing"];

		$( "#search" ).autocomplete({
		  source: availableTags
		});
	  });
  </script>
</body>